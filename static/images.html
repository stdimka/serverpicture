<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Images</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F2F5FF;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 80%;
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            margin-bottom: 20px;
            text-align: center;
            color: #0B0B0B;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        .delete-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #FF3333;
            font-size: 18px;
        }
        .pagination {
            text-align: center;
        }
        .pagination button {
            background: #0060FF;
            color: white;
            border: none;
            margin: 0 3px;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
        }
        .pagination button.active {
            background: #0041b3;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Список изображений</h1>
    <table>
        <thead>
            <tr>
                <th>Имя файла</th>
                <th>URL</th>
                <th>Дата загрузки</th>
                <th>Удалить</th>
            </tr>
        </thead>
        <tbody id="file-table-body">
            <tr><td colspan="4">Загрузка...</td></tr>
        </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
</div>

<script>
    let currentPage = 1;
    let totalPages = 1;

    function loadImages(page = 1) {
        fetch(`/api/get-data?page=${page}`)
            .then(res => res.json())
            .then(data => {
                currentPage = data.page;
                const tbody = document.getElementById("file-table-body");
                tbody.innerHTML = "";

                if (!data.items.length) {
                    tbody.innerHTML = "<tr><td colspan='4'>Нет загруженных изображений</td></tr>";
                    return;
                }

                data.items.forEach(file => {
                    const row = document.createElement("tr");

                    const nameCell = document.createElement("td");
                    nameCell.textContent = file.original_name;

                    const linkCell = document.createElement("td");
                    const link = document.createElement("a");
                    link.href = `/images/${file.name}`;
                    link.target = "_blank";
                    link.textContent = window.location.origin + "/images/" + file.name;
                    linkCell.appendChild(link);

                    const dateCell = document.createElement("td");
                    dateCell.textContent = file.uploaded_at;

                    const deleteCell = document.createElement("td");
                    const delBtn = document.createElement("button");
                    delBtn.className = "delete-button";
                    delBtn.innerHTML = "&times;";
                    delBtn.onclick = () => {
                        if (confirm("Удалить файл?")) {
                            fetch(`/delete/${file.id}/`, { method: "POST" })
                                .then(() => loadImages(currentPage))
                                .catch(err => alert("Ошибка при удалении"));
                        }
                    };
                    deleteCell.appendChild(delBtn);

                    row.appendChild(nameCell);
                    row.appendChild(linkCell);
                    row.appendChild(dateCell);
                    row.appendChild(deleteCell);

                    tbody.appendChild(row);
                });

                totalPages = Math.ceil(data.total / 5);
                renderPagination();
            })
            .catch(err => {
                console.error("Ошибка:", err);
                document.getElementById("file-table-body").innerHTML =
                    "<tr><td colspan='4'>Ошибка загрузки списка</td></tr>";
            });
    }

    function renderPagination() {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            if (i === currentPage) btn.classList.add("active");
            btn.onclick = () => loadImages(i);
            paginationDiv.appendChild(btn);
        }
    }

    loadImages();
</script>

</body>
</html>
